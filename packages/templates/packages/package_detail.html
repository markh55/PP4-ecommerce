{% extends 'core/base.html' %}
{% load static %}

{% block content %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'packages/css/package_detail.css' %}"/>
{% endblock %}

<section id="package-detail" class="container my-6">
  <h2 class="section-title"><strong>Package Details</strong></h2>
  <div class="row">
    <!-- Package Image -->
    <div class="col-lg-6 col-md-12 mb-4">
      {% if package.image %}
      <img
        src="{{ package.image.url }}"
        alt="{{ package.name }}"
        class="img-fluid rounded"
        onerror="this.style.display='none'"
      />
      {% else %}
      <img
        src="{% static 'images/default-package.png' %}"
        alt="No Image"
        class="img-fluid rounded"
      />
      {% endif %}
    </div>

    <!-- Package Details -->
    <div class="col-lg-6 col-md-12 d-flex flex-column justify-content-start">
      <h1>{{ package.name }}</h1>
      <h4>Tier: {{ package.get_tier_display }}</h4>

      <!-- Rating Display -->
      <div class="mb-3">
        {% if package.rating_count > 0 %}
          <div class="d-flex align-items-center">
            <span class="h5 me-2">{{ package.average_rating|floatformat:1 }}/5</span>
            <div class="stars me-2">
              {% for i in "12345" %}
                {% if forloop.counter <= package.average_rating %}
                  <i class="fas fa-star text-warning"></i>
                {% else %}
                  <i class="far fa-star text-warning"></i>
                {% endif %}
              {% endfor %}
            </div>
            <small class="text-muted">({{ package.rating_count }} rating{{ package.rating_count|pluralize }})</small>
          </div>
        {% else %}
          <p class="text-muted">No ratings yet</p>
        {% endif %}
      </div>

      <p class="mt-3">{{ package.description }}</p>
      <p class="h5 mt-3"><strong>Price:</strong> Â£{{ package.price }}</p>

      <!-- CTA Button -->
      <form
        class="form text-center"
        action="{% url 'bag:add_to_bag' package.id %}"
        method="POST"
      >
        {% csrf_token %}
        <div class="col-12 mb-4">
          <input type="submit" class="btn-package mt-3" value="Add to Bag" />
        </div>
        <div class="col-12 mb-3">
          <a href="{% url 'packages:package_list' %}" class="btn-package">
            <span class="icon">
              <i class="fas fa-chevron-left"></i>
            </span>
            <span class="text-uppercase">Back</span>
          </a>
        </div>
        <input type="hidden" name="redirect_url" value="{{ request.path }}" />
      </form>
    </div>
  </div>
</section>

<!-- Reviews Section -->
<section id="reviews" class="container my-6">
  <div class="row">
    <div class="col-12">
      <h3 class="section-title"><strong>Reviews</strong></h3>

      <!-- Add Review Form (only for authenticated users) -->
      {% if user.is_authenticated %}
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">Write a Review</h5>
            <form method="POST" action="{% url 'packages:add_review' package.slug %}">
              {% csrf_token %}

              <!-- Rating -->
              <div class="mb-3">
                <label for="rating" class="form-label">Rating</label>
                <select class="form-control" id="rating" name="rating" required>
                  <option value="">Select Rating</option>
                  <option value="1">1 Star</option>
                  <option value="2">2 Stars</option>
                  <option value="3">3 Stars</option>
                  <option value="4">4 Stars</option>
                  <option value="5">5 Stars</option>
                </select>
              </div>

              <!-- Review Title -->
              <div class="mb-3">
                <label for="title" class="form-label">Title</label>
                <input type="text" class="form-control" id="title" name="title" required>
              </div>

              <!-- Review Body -->
              <div class="mb-3">
                <label for="body" class="form-label">Review</label>
                <textarea class="form-control" id="body" name="body" rows="4" required></textarea>
              </div>

              <button type="submit" class="btn btn-primary">Submit Review</button>
            </form>
          </div>
        </div>
      {% else %}
        <p class="text-muted mb-4"><a href="{% url 'account_login' %}">Login</a> to write a review.</p>
      {% endif %}

      <!-- Existing Reviews -->
      {% if package.reviews.all %}
        <div class="reviews-list">
          {% for review in package.reviews.all %}
            <div class="card mb-3">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h5 class="card-title">{{ review.title }}</h5>
                  <small class="text-muted">{{ review.created_at|date:"M d, Y" }}</small>
                </div>

                <!-- Review Rating -->
                <div class="mb-2">
                  {% for i in "12345" %}
                    {% if forloop.counter <= review.user.ratings.get.rating %}
                      <i class="fas fa-star text-warning"></i>
                    {% else %}
                      <i class="far fa-star text-warning"></i>
                    {% endif %}
                  {% endfor %}
                </div>

                <p class="card-text">{{ review.body }}</p>
                <small class="text-muted">by {{ review.user.username }}</small>

                <div class="mt-3">
                  <a href="{% url 'packages:edit_review' review.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
                  <button class="btn btn-sm btn-outline-danger">Delete</button>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted">No reviews yet. Be the first to review this package!</p>
      {% endif %}
    </div>
  </div>
</section>

{% endblock %}